<html>
  <head>
    <script src="https://code.createjs.com/createjs-2015.11.26.min.js"></script>
    <script>
      //{"1,2" : ["N","W"],"3,2" : ["N"],"0,0" : ["S"],"3,0" : ["W"],"0,4" : ["E"],"1,4" : ["N","W","E"],"1,3" : ["W","S"],"2,3" : ["N","E"],"2,1" : ["W","E","S"],"2,4" : ["W"],"4,2" : ["N"],"1,0" : ["S","E"],"0,3" : ["N","E"],"4,0" : ["S"],"0,1" : ["E","N"],"3,3" : ["W","S","E"],"4,1" : ["W","N","S"],"3,1" : ["W","E","S"],"4,4" : ["N"],"0,2" : ["E","S"],"2,0" : ["W","E"],"4,3" : ["W","S"],"2,2" : ["N","S"],"3,4" : ["N"],"1,1" : ["N","W","S","E"]}

      var labyrinthObject = {"1,2" : ["W","E","N","S"],"3,2" : ["W","N","E"],"0,0" : ["E"],"3,0" : ["S","W"],"0,4" : ["E"],"1,4" : ["E","W"],"1,3" : ["N"],"2,3" : ["N","E","S"],"2,1" : ["W"],"2,4" : ["N","W"],"4,2" : ["W","S"],"1,0" : ["S","W"],"0,3" : ["N"],"4,0" : ["S"],"0,1" : ["E"],"3,3" : ["W","S"],"4,1" : ["W","N"],"3,1" : ["S","N","E"],"4,4" : ["N"],"0,2" : ["E","S"],"2,0" : ["E"],"4,3" : ["N","S"],"2,2" : ["W","E","S"],"3,4" : ["N"],"1,1" : ["S","N","E","W"]};
      var playerObject = [0,0];
      var goalObject = [2,2];

      var labSize;
      var labWidth;
      var labHeight;
      var cellSize;
      var xPlayer = 0;
      var yPlayer = 0;
      var stage;
      var labyrinth;
      var player;
      var goal;
      var trajectory;

      function findLabyrinthSize(lab){
         maxWidth = 0;
         maxHeight = 0;
         for (var key in lab) {
            var coords = key.split(",");
            width = parseInt(coords[0]);
            height = parseInt(coords[1]);
            if(width > maxWidth){
               maxWidth = width;
            } if(height > maxHeight){
               maxHeight = height;
            }
         }
         labWidth = maxWidth + 1;
         labHeight = maxHeight + 1;
         // TODO Until we allow rectangular sizes
         labSize = labWidth;
         cellSize = 400 / labSize;
      }

      function updateLabyrinth(){
         labyrinthObject = JSON.parse(document.getElementById('Labyrinth').value);
         playerObject = JSON.parse(document.getElementById('Player').value);
         goalObject = JSON.parse(document.getElementById('Goal').value);
         console.log(labyrinthObject);
         labyrinth.graphics.clear();
         drawLabyrinth();
         drawPlayer();
         drawGoal();
         stage.update(event);
      }

      function drawLabyrinth(){
         findLabyrinthSize(labyrinthObject);
         lab_graph = labyrinth.graphics;
         lab_graph.beginStroke("green").mt(0,0);
         lab_graph.lt(0,400).lt(400,400).lt(400,0).lt(0,0);

         lab_graph.beginStroke("yellow");
         // var labyrinthObject = {"0,1" : ["E","W",],"2,0" : ["E","N",],"0,0" : ["S","E",],"2,2" : ["W",],"1,0" : ["N","S",],"1,2" : ["W",],"1,1" : ["S","E",],"2,1" : ["W","N","E",],"0,2" : ["W",],};
         for(x = 0; x < labSize; x++){
            for(y = 0; y < labSize; y++){
               var walls = labyrinthObject[[x,y]];
               if(!walls.includes("S")){
                  lab_graph.mt(x*cellSize,(y+1)*cellSize).lt((x+1)*cellSize,(y+1)*cellSize);
               } if(!walls.includes("E")){
                  lab_graph.mt((x+1)*cellSize,y*cellSize).lt((x+1)*cellSize,(y+1)*cellSize);
               } if(!walls.includes("N")){
                  lab_graph.mt(x*cellSize,y*cellSize).lt((x+1)*cellSize,y*cellSize);
               } if(!walls.includes("W")){
                  lab_graph.mt(x*cellSize,y*cellSize).lt(x*cellSize,(y+1)*cellSize);
               }
            }
         }
      }

      function drawPlayer(){
         var bounds = player.getBounds();
         player.scaleX = cellSize / bounds.width;
         player.scaleY = cellSize / bounds.height;
         player.x = (playerObject[0] * cellSize) + 50;
         player.y = (playerObject[1] * cellSize) + 50;
         stage.update(event);
      }

      function drawGoal(){
         var bounds = goal.getBounds();
         goal.scaleX = cellSize / bounds.width;
         goal.scaleY = cellSize / bounds.height;
         goal.x = (goalObject[0] * cellSize) + 50;
         goal.y = (goalObject[1] * cellSize) + 50;
         stage.update(event);
      }

      function playOnce() {
         xPlayer++;
         if(xPlayer >= labSize){
            xPlayer = 0;
            yPlayer++;
            if(yPlayer >= labSize){
               yPlayer = 0;
            }
         }
         trajectory.graphics.clear().beginFill("red").drawCircle(50, 50, cellSize/5);
         trajectory.x = (xPlayer * cellSize + cellSize/2);
         trajectory.y = (yPlayer * cellSize + cellSize / 2);
         // stage.addChild(player);
         stage.update(event);
      }

      function init() {
         stage = new createjs.Stage("demoCanvas");
         player = new createjs.Bitmap("mario.png");
         goal = new createjs.Bitmap("goal.png");
         trajectory = new createjs.Shape();
         labyrinth = new createjs.Shape();
         var background = new createjs.Shape();
         background.graphics.beginFill("blue").drawRect(0, 0, 500, 500);

         drawLabyrinth();
         drawPlayer();
         drawGoal();
         labyrinth.x = 50;
         labyrinth.y = 50;

         stage.addChild(background);
         stage.addChild(labyrinth);
         stage.addChild(player);
         stage.addChild(goal);
         stage.addChild(trajectory);


         // stage.addChild(bitmap);


         stage.update();

         createjs.Ticker.addEventListener("tick", playOnce);

         createjs.Ticker.setInterval(500);
      }
    </script>
  </head>
  <body onload="init();">
      <canvas id="demoCanvas" width="500" height="500"></canvas>
      <br />
      JSON Labyrinth : <input id="Labyrinth" type="text" value='{"1,2" : ["N","W"],"3,2" : ["N"],"0,0" : ["S"],"3,0" : ["W"],"0,4" : ["E"],"1,4" : ["N","W","E"],"1,3" : ["W","S"],"2,3" : ["N","E"],"2,1" : ["W","E","S"],"2,4" : ["W"],"4,2" : ["N"],"1,0" : ["S","E"],"0,3" : ["N","E"],"4,0" : ["S"],"0,1" : ["E","N"],"3,3" : ["W","S","E"],"4,1" : ["W","N","S"],"3,1" : ["W","E","S"],"4,4" : ["N"],"0,2" : ["E","S"],"2,0" : ["W","E"],"4,3" : ["W","S"],"2,2" : ["N","S"],"3,4" : ["N"],"1,1" : ["N","W","S","E"]}'/>
      <br />
      JSON Player : <input id="Player" type="text" value="[0,0]"/>
      <br />
      JSON Goal : <input id="Goal" type="text" value="[2,2]"/>
      <br />
      JSON Solution : <input id="Solution" type="text" value='["N", "S", "E", "S"]'/>
      <br />
      <input type="button" value="Update Labyrinth" onclick="updateLabyrinth();" />
  </body>
</html>
